using Ardalis.Result;using AutoMapper;using KCloud.Auth.Interfaces;using KCloud.Auth.Models;using KCloud.Auth.Models.DTO;using KCloud.Auth.Models.Entity;using MediatR;using Microsoft.EntityFrameworkCore;using Microsoft.Extensions.Localization;namespace KCloud.Auth.Features.Authentication.Commands;public class RefreshTokenCommandHandler : IRequestHandler<RefreshTokenCommand, Result<AuthResult>>{    private readonly IUnitOfWork _unitOfWork;    private readonly ITokenService _tokenService;    private readonly IRefreshTokenService _refreshTokenService;    private readonly IMapper _mapper;    private readonly ILogger<RefreshTokenCommandHandler> _logger;    private readonly IStringLocalizer _localizer;    public RefreshTokenCommandHandler(        IUnitOfWork unitOfWork,        ITokenService tokenService,        IRefreshTokenService refreshTokenService,        IMapper mapper,        ILogger<RefreshTokenCommandHandler> logger,        IStringLocalizer localizer)    {        _unitOfWork = unitOfWork;        _tokenService = tokenService;        _refreshTokenService = refreshTokenService;        _mapper = mapper;        _logger = logger;        _localizer = localizer;    }    public async Task<Result<AuthResult>> Handle(RefreshTokenCommand request, CancellationToken cancellationToken)    {        try        {            var storedRefreshToken = await _unitOfWork.Repository<RefreshToken>()                .Query()                .Include(rt => rt.User) // Include user data                .FirstOrDefaultAsync(rt => rt.Token == request.RefreshToken, cancellationToken);            if (storedRefreshToken == null)            {                return Result<AuthResult>.Error(_localizer["InvalidRefreshToken"].Value);            }                        if (storedRefreshToken.ExpiryTime <= DateTime.UtcNow)            {                _unitOfWork.Repository<RefreshToken>().Delete(storedRefreshToken);                await _unitOfWork.CommitAsync(cancellationToken);                return Result<AuthResult>.Error(_localizer["RefreshTokenExpired"].Value);            }                        var user = storedRefreshToken.User;            if (user == null)            {                return Result<AuthResult>.Error(_localizer["UserNotFound"].Value);            }                        var userDto = _mapper.Map<UserDTO>(user);            var newAccessToken = _tokenService.GenerateJwtToken(userDto);            var newRefreshToken = await _refreshTokenService.GenerateRefreshTokenAsync(user.Id, cancellationToken);            var authResult = _mapper.Map<AuthResult>(user);            authResult.Token = newAccessToken;            authResult.RefreshToken = newRefreshToken;            authResult.Message = _localizer["TokenRefreshed"].Value;            return Result<AuthResult>.Success(authResult);        }        catch (Exception ex)        {            _logger.LogError(ex, "Error during token refresh");            return Result<AuthResult>.Error(_localizer["UnexpectedError"].Value);        }    }}