// KCloud.Auth/Services/RefreshTokenService.csusing KCloud.Auth.Interfaces;using KCloud.Auth.Models.Entity;using Microsoft.EntityFrameworkCore;namespace KCloud.Auth.Services;public class RefreshTokenService : IRefreshTokenService{    private readonly IUnitOfWork _unitOfWork;    private readonly ITokenService _tokenService;    private readonly int _refreshTokenExpiryDays;    private readonly ILogger<RefreshTokenService> _logger;    public RefreshTokenService(        IUnitOfWork unitOfWork,        ITokenService tokenService,        IConfiguration configuration, ILogger<RefreshTokenService> logger)    {        _unitOfWork = unitOfWork;        _tokenService = tokenService;        _logger = logger;        _refreshTokenExpiryDays = configuration.GetValue<int>("Jwt:RefreshTokenExpiryDays", 7);    }    public async Task<string> GenerateRefreshTokenAsync(Guid userId, CancellationToken cancellationToken = default)    {        // Get existing refresh tokens for this user        var refreshTokens = await _unitOfWork.Repository<RefreshToken>().GetAllAsync();        var existingRefreshToken = refreshTokens.FirstOrDefault(rt => rt.UserId == userId);        // Remove existing refresh token if any        if (existingRefreshToken != null)        {            _unitOfWork.Repository<RefreshToken>().Delete(existingRefreshToken);        }        // Create new refresh token        var refreshToken = new RefreshToken        {            Token = _tokenService.GenerateRefreshToken(),            ExpiryTime = DateTime.UtcNow.AddDays(_refreshTokenExpiryDays),            UserId = userId        };        // Add refresh token to repository        await _unitOfWork.Repository<RefreshToken>().AddAsync(refreshToken, cancellationToken);                // Save changes to database        await _unitOfWork.CommitAsync(cancellationToken);        return refreshToken.Token;    }    public async Task<bool> ValidateRefreshTokenAsync(Guid userId, string token, CancellationToken cancellationToken = default)    {        var refreshToken = await _unitOfWork.Repository<RefreshToken>()            .Query()            .FirstOrDefaultAsync(rt => rt.UserId == userId && rt.Token == token, cancellationToken);        if (refreshToken == null)        {            _logger.LogWarning("No refresh token found for user {UserId}", userId);            return false;        }        if (refreshToken.ExpiryTime <= DateTime.UtcNow)        {            _logger.LogWarning("Refresh token expired for user {UserId}", userId);            return false;        }        return true;    }    public async Task<bool> RevokeRefreshTokenAsync(Guid userId, CancellationToken cancellationToken = default)    {        var refreshTokens = await _unitOfWork.Repository<RefreshToken>().GetAllAsync();        var refreshToken = refreshTokens.FirstOrDefault(rt => rt.UserId == userId);        if (refreshToken == null)        {            return false;        }        _unitOfWork.Repository<RefreshToken>().Delete(refreshToken);        await _unitOfWork.CommitAsync(cancellationToken);        return true;    }}