using Ardalis.Result;using KCloud.Common.Helpers;using KCloud.FileMetadata.Interfaces;using KCloud.FileMetadata.Models.DTO;using KCloud.FileMetadata.Models.Entity;using MediatR;using Microsoft.EntityFrameworkCore;using Microsoft.Extensions.Localization;namespace KCloud.FileMetadata.Features.Folders.Commands;public class DeleteFolderCommandHandler(    IUnitOfWork unitOfWork,    IFolderDeleteService folderDeleteService,    ILogger<DeleteFolderCommandHandler> logger,    IStringLocalizer localizer,    IHttpContextAccessor httpContextAccessor)    : IRequestHandler<DeleteFolderCommand, Result<DeleteFolderResponseDTO>>{    public async Task<Result<DeleteFolderResponseDTO>> Handle(DeleteFolderCommand request, CancellationToken cancellationToken)    {        var currentUserId = CurrentUserHelper.GetUserId(httpContextAccessor);                try        {            if (currentUserId == null)            {                logger.LogWarning("Unauthenticated user attempted to delete folder {FolderId}", request.Id);                return Result<DeleteFolderResponseDTO>.Unauthorized();            }            var folder = await unitOfWork.Repository<Folder>()                .Query()                .Include(f => f.Files.Where(file => !file.IsDeleted))                .Include(f => f.SubFolders.Where(sub => !sub.IsDeleted))                .FirstOrDefaultAsync(f => f.Id == request.Id &&                                          f.UserId == currentUserId.Value &&                                          !f.IsDeleted, cancellationToken);            if (folder == null)            {                logger.LogWarning("User {UserId} attempted to delete non-existent or unauthorized folder {FolderId}",                     currentUserId, request.Id);                return Result<DeleteFolderResponseDTO>.Error(localizer["FolderNotFoundForDeletion"]);            }            var hasFiles = folder.Files.Any();            var hasSubFolders = folder.SubFolders.Any();            var hasContent = hasFiles || hasSubFolders;            // Validate content handling strategy            if (hasContent && !request.DeleteContents && !request.MoveContentsToParent && !request.MoveContentsToRoot)            {                logger.LogWarning("User {UserId} attempted to delete non-empty folder {FolderId} without specifying content handling",                     currentUserId, request.Id);                return Result<DeleteFolderResponseDTO>.Error(localizer["FolderNotEmptySpecifyContentHandling"]);            }            // Validate conflicting options            var contentOptionsCount = new[] { request.DeleteContents, request.MoveContentsToParent, request.MoveContentsToRoot }                .Count(option => option);                        if (contentOptionsCount > 1)            {                logger.LogWarning("User {UserId} specified multiple content handling options for folder {FolderId}",                     currentUserId, request.Id);                return Result<DeleteFolderResponseDTO>.Error(localizer["MultipleContentHandlingOptionsSpecified"]);            }            var response = new DeleteFolderResponseDTO            {                Success = true,                Message = "Folder deleted successfully" // This will be replaced by localized success message in MVC            };            if (hasContent)            {                try                {                    if (request.DeleteContents)                    {                        logger.LogInformation("Deleting all content for folder {FolderId} by user {UserId}",                             request.Id, currentUserId);                        var deletedFileIds = await folderDeleteService.DeleteAllContentRecursivelyAsync(folder, cancellationToken);                        response.DeletedFileIds = deletedFileIds;                        response.DeletedFileCount = deletedFileIds.Count;                                                logger.LogInformation("Deleted {FileCount} files from folder {FolderId}",                             deletedFileIds.Count, request.Id);                    }                    else if (request.MoveContentsToParent)                    {                        logger.LogInformation("Moving content to parent for folder {FolderId} by user {UserId}",                             request.Id, currentUserId);                        await folderDeleteService.MoveContentToParentAsync(folder, cancellationToken);                    }                    else if (request.MoveContentsToRoot)                    {                        logger.LogInformation("Moving content to root for folder {FolderId} by user {UserId}",                             request.Id, currentUserId);                        await folderDeleteService.MoveContentToRootAsync(folder, cancellationToken);                    }                }                catch (Exception contentEx)                {                    logger.LogError(contentEx, "Error handling folder content during deletion of {FolderId} by user {UserId}",                         request.Id, currentUserId);                    return Result<DeleteFolderResponseDTO>.Error(localizer["FolderContentHandlingFailed"]);                }            }            // Delete the folder itself            unitOfWork.Repository<Folder>().Delete(folder);            await unitOfWork.CommitAsync(cancellationToken);            logger.LogInformation("Successfully deleted folder {FolderId} by user {UserId} with action DeleteContents={DeleteContents}, MoveToParent={MoveToParent}, MoveToRoot={MoveToRoot}",                 folder.Id, currentUserId, request.DeleteContents, request.MoveContentsToParent, request.MoveContentsToRoot);            return Result<DeleteFolderResponseDTO>.Success(response);        }        catch (Exception ex)        {            logger.LogError(ex, "Error deleting folder {FolderId} by user {UserId}",                 request.Id, currentUserId?.ToString() ?? "Unknown");            return Result<DeleteFolderResponseDTO>.Error(localizer["FolderDeletionFailed"]);        }    }}