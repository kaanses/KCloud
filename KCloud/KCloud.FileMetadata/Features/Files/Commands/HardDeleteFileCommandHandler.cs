using Ardalis.Result;using KCloud.Common.Helpers;using KCloud.FileMetadata.Interfaces;using KCloud.FileMetadata.Models.DTO;using MediatR;using Microsoft.EntityFrameworkCore;using Microsoft.Extensions.Localization;namespace KCloud.FileMetadata.Features.Files.Commands;public class HardDeleteFileCommandHandler(    IUnitOfWork unitOfWork,    ILogger<HardDeleteFileCommandHandler> logger,    IStringLocalizer localizer,    IHttpContextAccessor httpContextAccessor)    : IRequestHandler<HardDeleteFileCommand, Result<HardDeleteResultDTO>>{    public async Task<Result<HardDeleteResultDTO>> Handle(HardDeleteFileCommand request, CancellationToken cancellationToken)    {        try        {            var currentUserId = CurrentUserHelper.GetUserId(httpContextAccessor);            if (currentUserId == null)            {                return Result.Unauthorized(localizer["Unauthorized"].Value);            }            var deletedFileIds = new List<Guid>();            if (request.EmptyTrash)            {                var deletedFiles = await unitOfWork.Repository<Models.Entity.FileMetadata>()                    .Query()                    .Where(f => f.UserId == currentUserId.Value && f.IsDeleted)                    .ToListAsync(cancellationToken);                if (!deletedFiles.Any())                {                    return Result.Success(new HardDeleteResultDTO(deletedFileIds));                }                // Collect file IDs before deleting                deletedFileIds.AddRange(deletedFiles.Select(f => f.Id));                foreach (var item in deletedFiles)                {                    unitOfWork.Repository<Models.Entity.FileMetadata>().Delete(item);                }                await unitOfWork.CommitAsync(cancellationToken);                logger.LogInformation("Hard deleted {Count} files for user {UserId}", deletedFiles.Count, currentUserId);                                return Result.Success(new HardDeleteResultDTO(deletedFileIds));            }                       var file = await unitOfWork.Repository<Models.Entity.FileMetadata>()                .Query()                .FirstOrDefaultAsync(f => f.Id == request.FileId, cancellationToken);                        if (file == null)            {                return Result.NotFound();            }                         if (file.UserId != currentUserId.Value)            {                return Result.Forbidden();            }                        deletedFileIds.Add(file.Id);                        unitOfWork.Repository<Models.Entity.FileMetadata>().Delete(file);            await unitOfWork.CommitAsync(cancellationToken);            logger.LogInformation("Hard deleted file: {FileId} by user {UserId}", file.Id, currentUserId);                        return Result.Success(new HardDeleteResultDTO(deletedFileIds));                    }        catch (Exception ex)        {            logger.LogError(ex, "Error hard deleting file {FileId}", request.FileId);            return Result.Error(localizer["FileHardDeleteFailed"].Value);        }    }}