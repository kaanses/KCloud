using Ardalis.Result;using Microsoft.EntityFrameworkCore;using AutoMapper;using KCloud.Common.Helpers;using KCloud.FileMetadata.Helpers;using KCloud.FileMetadata.Interfaces;using KCloud.FileMetadata.Models.DTO;using MediatR;using Microsoft.EntityFrameworkCore;using Microsoft.Extensions.Localization;namespace KCloud.FileMetadata.Features.Files.Queries;public class GetDeletedFilesQueryHandler : IRequestHandler<GetDeletedFilesQuery, Result<List<FileMetadataDTO>>>{    private readonly IUnitOfWork _unitOfWork;    private readonly IMapper _mapper;    private readonly ILogger<GetDeletedFilesQueryHandler> _logger;    private readonly IStringLocalizer _localizer;    private readonly IHttpContextAccessor _httpContextAccessor;    public GetDeletedFilesQueryHandler(        IUnitOfWork unitOfWork,        IMapper mapper,        ILogger<GetDeletedFilesQueryHandler> logger,        IStringLocalizer localizer,        IHttpContextAccessor httpContextAccessor)    {        _unitOfWork = unitOfWork;        _mapper = mapper;        _logger = logger;        _localizer = localizer;        _httpContextAccessor = httpContextAccessor;    }    public async Task<Result<List<FileMetadataDTO>>> Handle(GetDeletedFilesQuery request, CancellationToken cancellationToken)    {        try        {            var currentUserId = CurrentUserHelper.GetUserId(_httpContextAccessor);            if (currentUserId == null)            {                return Result.Unauthorized(_localizer["Unauthorized"]);            }            var deletedFilesQuery = _unitOfWork.Repository<Models.Entity.FileMetadata>()                .Query()                .Include(f => f.Folder)                .Where(f => f.UserId == currentUserId.Value && f.IsDeleted);            // Apply search if provided            if (!string.IsNullOrWhiteSpace(request.SearchTerm))            {                var searchTerm = request.SearchTerm.ToLower();                deletedFilesQuery = deletedFilesQuery.Where(f =>                     f.FileName.ToLower().Contains(searchTerm) ||                    f.ContentType.ToLower().Contains(searchTerm)                );            }            var deletedFiles = await deletedFilesQuery                .OrderByDescending(f => f.DeletedAt)                .ToListAsync(cancellationToken);            var result = _mapper.Map<List<FileMetadataDTO>>(deletedFiles);            _logger.LogInformation("Retrieved {Count} deleted files for user {UserId}",                 deletedFiles.Count, currentUserId);            return Result<List<FileMetadataDTO>>.Success(result);        }        catch (Exception ex)        {            _logger.LogError(ex, "Error getting deleted files");            return Result<List<FileMetadataDTO>>.Error(_localizer["FailedToRetrieveDeletedFiles"]);        }    }}