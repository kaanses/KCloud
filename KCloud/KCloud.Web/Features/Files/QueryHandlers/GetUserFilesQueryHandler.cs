using System.Text.Json;using Ardalis.Result;using KCloud.Web.Features.Files.Queries;using KCloud.Web.Models.DTO;using KCloud.Web.Interfaces;using MediatR;namespace KCloud.Web.Features.Files.QueryHandlers;public class GetUserFilesQueryHandler(    IHttpClientFactory httpClientFactory,    IAuthTokenService tokenService,    ILogger<GetUserFilesQueryHandler> logger,    IParseServerResponseService parseServerResponseService)    : IRequestHandler<GetUserFilesQuery, Result<UserFilesResponseDTO>>{    private readonly JsonSerializerOptions _jsonOptions = new() { PropertyNameCaseInsensitive = true };    public async Task<Result<UserFilesResponseDTO>> Handle(GetUserFilesQuery request, CancellationToken cancellationToken)    {        try        {            var httpClient = httpClientFactory.CreateClient("KCloudGateway");            var queryParams = new List<string>();                        queryParams.Add($"isSharedWithMe={request.IsSharedWithMe}");            queryParams.Add($"isTrash={request.IsTrash}");                        if (request.FolderId.HasValue)                queryParams.Add($"folderId={request.FolderId.Value}");                        if (!string.IsNullOrWhiteSpace(request.SearchTerm))                queryParams.Add($"searchTerm={Uri.EscapeDataString(request.SearchTerm)}");                                    if (request.OrderBy != null)                queryParams.Add($"orderBy={request.OrderBy}");                        if (request.Descending)                queryParams.Add($"descending=true");                        var queryString = queryParams.Count > 0 ? "?" + string.Join("&", queryParams) : "";            var endpoint = $"/file/get-files{queryString}";            logger.LogDebug("Requesting files from endpoint: {Endpoint}", endpoint);            var response = await httpClient.GetAsync(endpoint, cancellationToken);            var responseContent = await response.Content.ReadAsStringAsync(cancellationToken);            if (response.IsSuccessStatusCode)            {                logger.LogDebug("Successfully retrieved user files");                return await parseServerResponseService.ParseSuccessResponse<UserFilesResponseDTO>(responseContent);            }                        logger.LogWarning("Failed to retrieve user files. Status: {StatusCode}", response.StatusCode);            return await parseServerResponseService.ParseErrorResponse<UserFilesResponseDTO>(                responseContent,                 (int)response.StatusCode);        }        catch (Exception ex)        {            logger.LogError(ex, "Network error retrieving user files");            return Result<UserFilesResponseDTO>.Error("Unable to connect to server");        }    }}