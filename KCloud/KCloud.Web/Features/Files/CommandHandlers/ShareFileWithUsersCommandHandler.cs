using System.Text;using System.Text.Json;using Ardalis.Result;using KCloud.Web.Features.Files.Commands;using KCloud.Web.Interfaces;using KCloud.Web.Models.DTO;using MediatR;namespace KCloud.Web.Features.Files.CommandHandlers;public class ShareFileWithUsersCommandHandler(    IHttpClientFactory httpClientFactory,    ILogger<ShareFileWithUsersCommandHandler> logger,    IParseServerResponseService parseServerResponseService)    : IRequestHandler<ShareFileWithUsersCommand, Result<List<FileShareDTO>>>{    private readonly JsonSerializerOptions _jsonOptions = new()    {        PropertyNameCaseInsensitive = true,        PropertyNamingPolicy = JsonNamingPolicy.CamelCase    };    public async Task<Result<List<FileShareDTO>>> Handle(ShareFileWithUsersCommand request, CancellationToken cancellationToken)    {        try        {            var httpClient = httpClientFactory.CreateClient("KCloudGateway");            var json = JsonSerializer.Serialize(request, _jsonOptions);            var content = new StringContent(json, Encoding.UTF8, "application/json");            var response = await httpClient.PostAsync("/file/share-with-users", content, cancellationToken);            var responseContent = await response.Content.ReadAsStringAsync(cancellationToken);            if (response.IsSuccessStatusCode)            {                logger.LogInformation("Successfully shared file {FileId} with users", request.FileId);                return await parseServerResponseService.ParseSuccessResponse<List<FileShareDTO>>(responseContent);            }            logger.LogError("Share file failed with status {StatusCode}: {Response}",                 response.StatusCode, responseContent);            var errorResult = await parseServerResponseService.ParseErrorResponse<List<FileShareDTO>>(                responseContent, (int)response.StatusCode);                        return Result.Error(string.Join(", ", errorResult.Errors));        }        catch (Exception ex)        {            logger.LogError(ex, "Network error during file sharing for FileId: {FileId}", request.FileId);            return Result.Error("Unable to connect to server");        }    }}