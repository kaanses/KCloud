using AutoMapper;using KCloud.Web.Features.Files.CommandHandlers;using KCloud.Web.Features.Files.Commands;using KCloud.Web.Features.Files.Queries;using KCloud.Web.Models;using KCloud.Web.Models.ViewModel;using MediatR;using Microsoft.AspNetCore.Authorization;using Microsoft.AspNetCore.Mvc;namespace KCloud.Web.Controllers;[Route("[controller]")]public class FileController(IMediator mediator, ILogger<FileController> logger, IMapper mapper)    : Controller{    [HttpGet]    public async Task<IActionResult> Index(        Guid? folderId = null,         string? search = null,         bool isSharedWithMeFolder = false,        bool isTrash = false,                  string? orderBy = null,                 bool descending = true              )    {        var query = new GetUserFilesQuery(folderId, search, isSharedWithMeFolder, isTrash,orderBy, descending);        var result = await mediator.Send(query);        if (!result.IsSuccess)        {            TempData["Error"] = result.Errors.FirstOrDefault() ?? "Failed to load files";            return View(new FilesIndexViewModel());        }        var viewModel = mapper.Map<FilesIndexViewModel>(result.Value);        viewModel.CurrentFolderId = folderId;        viewModel.SearchTerm = search;        viewModel.IsSharedWithMeView = isSharedWithMeFolder;        viewModel.IsTrashView = isTrash;             viewModel.OrderBy = orderBy;                 viewModel.Descending = descending;          return View(viewModel);    }        [HttpPost("upload")]    [ValidateAntiForgeryToken]    public async Task<IActionResult> Upload([FromForm]UploadFileViewModel model)    {        if (!ModelState.IsValid || model.File == null || model.File.Length == 0)        {            return Json(new { success = false, message = "Please select a valid file." });        }        var command = new SaveFileCommand(model.File, model.FolderId);        var result = await mediator.Send(command);        if (!result.IsSuccess)        {            return Json(new             {                 success = false,                 message = result.Errors.FirstOrDefault() ?? "File upload failed."             });        }        return Json(new         {             success = true,             message = $"File '{model.File.FileName}' uploaded successfully!",            fileId = result.Value.Id,            fileName = result.Value.FileName        });    }    [HttpGet("download/{id}")]    public async Task<IActionResult> Download(Guid id, CancellationToken cancellationToken)    {        if (id == Guid.Empty)        {            TempData["Error"] = "Invalid file ID";            return RedirectToAction("Index");        }        var query = new DownloadFileQuery(id);        var result = await mediator.Send(query, cancellationToken);        if (!result.IsSuccess)        {            TempData["Error"] = result.Errors.FirstOrDefault() ?? "Download failed";            return RedirectToAction("Index");        }        var fileResponse = result.Value;            logger.LogInformation("Serving download for file: {FileName} ({FileId})",             fileResponse.FileName, id);            return File(            fileResponse.FileStream,             fileResponse.ContentType,            fileResponse.FileName,            enableRangeProcessing: true        );    }    [HttpPost("update")]    [ValidateAntiForgeryToken]    public async Task<IActionResult> Update([FromBody]UpdateFileViewModel model)    {        if (!ModelState.IsValid)        {            return Json(new { success = false, message = "Invalid data" });        }        var command = new UpdateFileCommand(model.Id, model.FileName, model.FolderId);        var result = await mediator.Send(command);        if (!result.IsSuccess)        {            return Json(new {                 success = false,                 message = result.Errors.FirstOrDefault() ?? "Update failed"             });        }        return Json(new {             success = true,             message = "File updated successfully!"         });    }    [HttpDelete("delete/{id}")]    public async Task<IActionResult> Delete(Guid id, bool hardDelete = false)    {        if (id == Guid.Empty)        {            return Json(new { success = false, message = "Invalid file ID" });        }        var command = new DeleteFileCommand(id, hardDelete);        var result = await mediator.Send(command);        if (!result.IsSuccess)        {            logger.LogError("Delete failed for {FileId}: {Errors}", id, string.Join(", ", result.Errors));            return Json(new { success = false, message = result.Errors.FirstOrDefault() ?? "Failed to delete file" });        }        var message = hardDelete ? "File permanently deleted" : "File moved to trash";        logger.LogInformation("Delete successful for {FileId}: {Message}", id, message);                return Json(new { success = true, message });    }    [HttpPost("empty-trash")]    public async Task<IActionResult> EmptyTrash()    {        var command = new EmptyTrashCommand();        var result = await mediator.Send(command);        if (!result.IsSuccess)        {            logger.LogError("Empty trash failed: {Errors}", string.Join(", ", result.Errors));            return Json(new { success = false, message = result.Errors.FirstOrDefault() ?? "Failed to empty trash" });        }        logger.LogInformation("Trash emptied successfully");        return Json(new { success = true, message = "Trash emptied successfully" });    }    [HttpPost("restore/{id?}")]    public async Task<IActionResult> Restore(Guid? id, bool isRestoreAll = false)    {                logger.LogInformation("MVC Controller received - ID: {Id}, isRestoreAll: {IsRestoreAll}", id, isRestoreAll);        var command = new RestoreFileCommand(id, isRestoreAll);        var result = await mediator.Send(command);        if (!result.IsSuccess)        {            logger.LogError("Restore failed for {FileId}: {Errors}", id, string.Join(", ", result.Errors));            return Json(new { success = false, message = result.Errors.FirstOrDefault() ?? "Failed to restore file" });        }        var message = id == null ? "All files restored successfully" : "File restored successfully";        logger.LogInformation("Restore successful for {FileId}", id);        return Json(new { success = true, message });    }}