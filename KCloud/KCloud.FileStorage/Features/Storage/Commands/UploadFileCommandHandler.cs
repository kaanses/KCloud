using Ardalis.Result;using FluentValidation;using KCloud.Common.Helpers;using KCloud.FileStorage.Helpers;using KCloud.FileStorage.Interfaces;using KCloud.FileStorage.Models.DTO;using MediatR;using Microsoft.Extensions.Localization;namespace KCloud.FileStorage.Features.Storage.Commands;public class UploadFileCommandHandler(    IFileStorageService fileStorageService,    IValidator<UploadFileCommand> validator,    ILogger<UploadFileCommandHandler> logger,    IStringLocalizer localizer,    IHttpContextAccessor httpContextAccessor)    : IRequestHandler<UploadFileCommand, Result<UploadResponseDTO>>{    public async Task<Result<UploadResponseDTO>> Handle(UploadFileCommand request, CancellationToken cancellationToken)    {        var currentUserId = CurrentUserHelper.GetUserId(httpContextAccessor);                try        {            var validationResult = await ValidationHelper.ValidateAsync(validator, request, logger);            if (!validationResult.IsSuccess)            {                return Result<UploadResponseDTO>.Invalid(validationResult.ValidationErrors);            }                        if (currentUserId == null)            {                logger.LogWarning("Unauthenticated user attempted to upload file {FileName}", request.File?.FileName);                return Result<UploadResponseDTO>.Unauthorized();            }                        var fileId = Guid.NewGuid();            var storagePath = StoragePathHelper.GenerateStoragePath(currentUserId.Value, fileId, request.File.FileName);            var guidFileName = StoragePathHelper.GenerateGuidFileName(fileId, request.File.FileName);            logger.LogInformation("Starting file upload: Original: {OriginalName}, GUID: {GuidName}, Size: {Size} bytes, User: {UserId}",                 request.File.FileName, guidFileName, request.File.Length, currentUserId);                        var saveResult = await fileStorageService.SaveFileAsync(request.File, storagePath, cancellationToken);            if (!saveResult.IsSuccess)            {                logger.LogError("File storage failed for {FileName} by user {UserId}: {Error}",                     request.File.FileName, currentUserId, saveResult.Errors.FirstOrDefault());                return Result<UploadResponseDTO>.Error(localizer["PhysicalFileUploadFailed"]);            }                        var uploadResponseDto = new UploadResponseDTO            {                Id = fileId,                FileName = request.File.FileName,                ContentType = request.File.ContentType,                FileSizeBytes = request.File.Length,                StoragePath = storagePath,                UserId = currentUserId.Value,                FolderId = request.FolderId            };            logger.LogInformation("File upload completed successfully: {FileId} by user {UserId}",                 fileId, currentUserId);            return Result<UploadResponseDTO>.Success(uploadResponseDto);        }        catch (Exception ex)        {            logger.LogError(ex, "Error uploading file: {FileName} by user {UserId}",                 request.File?.FileName, currentUserId?.ToString() ?? "Unknown");            return Result<UploadResponseDTO>.Error(localizer["FileUploadFailed"]);        }    }}